

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Query Methods &mdash; Riak Python Client 2.7.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Riak Python Client 2.7.0 documentation" href="index.html"/>
        <link rel="next" title="Security" href="security.html"/>
        <link rel="prev" title="Data Types" href="datatypes.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Riak Python Client
          

          
          </a>

          
            
            
              <div class="version">
                2.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="client.html">Client &amp; Connections</a></li>
<li class="toctree-l1"><a class="reference internal" href="bucket.html">Buckets &amp; Bucket Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="object.html">Values &amp; Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="datatypes.html">Data Types</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Query Methods</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#secondary-indexes">Secondary Indexes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#streaming-and-paginating-indexes">Streaming and Paginating Indexes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mapreduce">MapReduce</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#constructing-the-query">Constructing the query</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inputs">Inputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#phases">Phases</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#phase-shortcuts">Phase shortcuts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#execution">Execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shortcut-constructors">Shortcut constructors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#riak-search-2-0-yokozuna">Riak Search 2.0 (Yokozuna)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-schema">Creating a schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="#solr-indexes">Solr indexes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linking-a-bucket-type-to-an-index">Linking a bucket type to an index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#querying-an-index">Querying an index</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced Usage &amp; Internals</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Riak Python Client</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Query Methods</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/query.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="query-methods">
<h1>Query Methods<a class="headerlink" href="#query-methods" title="Permalink to this headline">¶</a></h1>
<p>Although most operations you will do involve directly interacting with
known buckets and keys, there are additional ways to get information
out of Riak.</p>
<div class="section" id="secondary-indexes">
<h2>Secondary Indexes<a class="headerlink" href="#secondary-indexes" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="object.html#object-accessors"><span class="std std-ref">Objects</span></a> can be <code class="xref py py-meth docutils literal"><span class="pre">tagged</span></code> with <code class="xref py py-attr docutils literal"><span class="pre">secondary</span> <span class="pre">index</span>
<span class="pre">entries</span></code>. Those entries can then
be queried over <code class="xref py py-meth docutils literal"><span class="pre">the</span> <span class="pre">bucket</span></code>
for equality or across ranges.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="s2">&quot;index_test&quot;</span><span class="p">)</span>

<span class="c1"># Tag an object with indexes and save</span>
<span class="n">sean</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;seancribbs&quot;</span><span class="p">)</span>
<span class="n">sean</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="s2">&quot;fname_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;Sean&quot;</span><span class="p">)</span>
<span class="n">sean</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span><span class="s2">&quot;byear_int&quot;</span><span class="p">,</span> <span class="mi">1979</span><span class="p">)</span>
<span class="n">sean</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

<span class="c1"># Performs an equality query</span>
<span class="n">seans</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;fname_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;Sean&quot;</span><span class="p">)</span>

<span class="c1"># Performs a range query</span>
<span class="n">eighties</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;byear_int&quot;</span><span class="p">,</span> <span class="mi">1980</span><span class="p">,</span> <span class="mi">1989</span><span class="p">)</span>
</pre></div>
</div>
<p>Secondary indexes are also available via <code class="xref py py-meth docutils literal"><span class="pre">MapReduce</span></code>.</p>
<div class="section" id="streaming-and-paginating-indexes">
<h3>Streaming and Paginating Indexes<a class="headerlink" href="#streaming-and-paginating-indexes" title="Permalink to this headline">¶</a></h3>
<p>Sometimes the number of results from such a query is too great to
process in one payload, so you can also <code class="xref py py-meth docutils literal"><span class="pre">stream</span> <span class="pre">the</span> <span class="pre">results</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">bucket</span><span class="o">.</span><span class="n">stream_index</span><span class="p">(</span><span class="s2">&quot;bmonth_int&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1"># keys is a list of matching keys</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</pre></div>
</div>
<p>Both the regular <code class="xref py py-meth docutils literal"><span class="pre">get_index()</span></code> method and
the <code class="xref py py-meth docutils literal"><span class="pre">stream_index()</span></code> method allow you to
return the index entry along with the matching key as tuples using the
<code class="docutils literal"><span class="pre">return_terms</span></code> option:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">bucket</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;byear_int&quot;</span><span class="p">,</span> <span class="mi">1970</span><span class="p">,</span> <span class="mi">1990</span><span class="p">,</span> <span class="n">return_terms</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># =&gt; [(1979, &#39;seancribbs&#39;)]</span>
</pre></div>
</div>
<p>You can also limit the number of results using the <code class="docutils literal"><span class="pre">max_results</span></code>
option, which enables pagination:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;fname_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p>Optionally you can use <code class="xref py py-meth docutils literal"><span class="pre">paginate_index()</span></code>
or <code class="xref py py-meth docutils literal"><span class="pre">paginate_stream_index()</span></code> to create a
generator of paged results:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">bucket</span><span class="o">.</span><span class="n">paginate_stream_index</span><span class="p">(</span><span class="s2">&quot;maestro_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;Cribbs&quot;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
        <span class="n">do_something</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>All of these features are implemented using the
<code class="xref py py-class docutils literal"><span class="pre">IndexPage</span></code> class, which emulates a
list but also supports streaming and capturing the
<code class="xref py py-attr docutils literal"><span class="pre">continuation</span></code>, which is a
sort of pointer to the next page of results:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Detect whether there are more results</span>
<span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">has_next_page</span><span class="p">():</span>

    <span class="c1"># Fetch the next page of results manually</span>
    <span class="n">more</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;fname_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                            <span class="n">continuation</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">continuation</span><span class="p">)</span>

    <span class="c1"># Fetch the next page of results automatically</span>
    <span class="n">more</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">next_page</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="mapreduce">
<h2>MapReduce<a class="headerlink" href="#mapreduce" title="Permalink to this headline">¶</a></h2>
<p><code class="xref py py-class docutils literal"><span class="pre">RiakMapReduce</span></code> allows you to construct query-processing jobs that
are performed mostly in-parallel around the Riak cluster. You can
think of it as a pipeline, where inputs are fed in one end, they pass
through a number of <code class="docutils literal"><span class="pre">map</span></code> and <code class="docutils literal"><span class="pre">reduce</span></code> phases, and then are
returned to the client.</p>
<div class="section" id="constructing-the-query">
<h3>Constructing the query<a class="headerlink" href="#constructing-the-query" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="inputs">
<h3>Inputs<a class="headerlink" href="#inputs" title="Permalink to this headline">¶</a></h3>
<p>The first step is to identify the inputs that should be processed.
They can be:</p>
<ol class="arabic simple">
<li>An entire <code class="xref py py-meth docutils literal"><span class="pre">bucket</span></code></li>
<li>An entire bucket, with the <code class="xref py py-meth docutils literal"><span class="pre">keys</span> <span class="pre">filtered</span> <span class="pre">by</span> <span class="pre">criteria</span></code></li>
<li>A <code class="xref py py-meth docutils literal"><span class="pre">list</span> <span class="pre">of</span> <span class="pre">bucket/key</span> <span class="pre">pairs</span></code> or bucket/key/data triples</li>
<li>A <code class="xref py py-meth docutils literal"><span class="pre">fulltext</span> <span class="pre">search</span> <span class="pre">query</span></code></li>
<li>A <code class="xref py py-meth docutils literal"><span class="pre">secondary-index</span> <span class="pre">query</span></code></li>
</ol>
<p>Adding inputs always returns the <code class="docutils literal"><span class="pre">RiakMapReduce</span></code> object so that you
can chain the construction of the query job.</p>
</div>
<div class="section" id="phases">
<h3>Phases<a class="headerlink" href="#phases" title="Permalink to this headline">¶</a></h3>
<p>The second step is to add processing phases to the query. <code class="docutils literal"><span class="pre">map</span></code>
phases load and process individual keys, returning one or more
results, while <code class="docutils literal"><span class="pre">reduce</span></code> phases operate over collections of results
from previous phases. <code class="docutils literal"><span class="pre">link</span></code> phases are a special type of <code class="docutils literal"><span class="pre">map</span></code>
phase that extract matching <code class="xref py py-attr docutils literal"><span class="pre">links</span></code>
from the object, usually so they can be used in a subsequent <code class="docutils literal"><span class="pre">map</span></code>
phase.</p>
<p>Any number of phases can return results directly to the client by
passing <code class="docutils literal"><span class="pre">keep=True</span></code>.</p>
<div class="section" id="phase-shortcuts">
<h4>Phase shortcuts<a class="headerlink" href="#phase-shortcuts" title="Permalink to this headline">¶</a></h4>
<p>A number of commonly-used phases are also available as shortcut
methods:</p>
</div>
</div>
<div class="section" id="execution">
<h3>Execution<a class="headerlink" href="#execution" title="Permalink to this headline">¶</a></h3>
<p>Query results can either be executed in one round-trip, or streamed
back to the client. The format of results will depend on the structure
of the <code class="docutils literal"><span class="pre">map</span></code> and <code class="docutils literal"><span class="pre">reduce</span></code> phases the query contains.</p>
</div>
<div class="section" id="shortcut-constructors">
<h3>Shortcut constructors<a class="headerlink" href="#shortcut-constructors" title="Permalink to this headline">¶</a></h3>
<p><code class="xref py py-class docutils literal"><span class="pre">RiakObject</span></code> contains some shortcut methods
that make it more convenient to begin constructing
<code class="xref py py-class docutils literal"><span class="pre">RiakMapReduce</span></code> queries.</p>
</div>
</div>
<div class="section" id="riak-search-2-0-yokozuna">
<span id="yz-label"></span><h2>Riak Search 2.0 (Yokozuna)<a class="headerlink" href="#riak-search-2-0-yokozuna" title="Permalink to this headline">¶</a></h2>
<p>With Riak 2.0 came the introduction of <strong>Riak Search 2.0</strong>, a.k.a <cite>Yokozuna</cite>
(the top rank in sumo).  Riak Search 2.0 is an integration of Solr (for
indexing and querying) and Riak (for storage and distribution).
It allows for distributed, scalable,
fault-tolerant, transparent indexing and querying of Riak values.
After connecting a bucket (or bucket type) to a
<a class="reference external" href="http://lucene.apache.org/solr">Apache Solr</a> index, you simply write
values (such as JSON, XML, plain text, Data Types, etc.) into Riak as
normal, and then query those indexed values using the Solr API.
Unlike traditional Riak data, however, Solr needs to know the format
of the stored data so it can index it.  Solr is a document-based
search engine so it treats each value stored in Riak as a document.</p>
<div class="section" id="creating-a-schema">
<h3>Creating a schema<a class="headerlink" href="#creating-a-schema" title="Permalink to this headline">¶</a></h3>
<p>The first thing which needs to be done is to define a Solr schema for
your data.  Riak Search comes bundled with a default schema named
<code class="docutils literal"><span class="pre">_yz_default</span></code>. It defaults to many dynamic field types, where the
suffix defines its type. This is an easy path to start development,
but we recommend in production that you define your own schema.</p>
<p>You can find information about defining your own schema at
<a class="reference external" href="http://docs.basho.com/riak/2.0.0/dev/advanced/search-schema">Search Schema</a>,
with a short section dedicated to the <a class="reference external" href="http://docs.basho.com/riak/2.0.0/dev/advanced/search-schema/#The-Default-Schema">default schema</a>.</p>
<p>Here is a brief example of creating a custom schema with
<code class="xref py py-meth docutils literal"><span class="pre">create_search_schema()</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="s2">&lt;schema name=&quot;test&quot; version=&quot;1.5&quot;&gt;</span>
<span class="s2">&lt;fields&gt;</span>
<span class="s2">   &lt;field name=&quot;_yz_id&quot; type=&quot;_yz_str&quot; indexed=&quot;true&quot; stored=&quot;true&quot;</span>
<span class="s2">    multiValued=&quot;false&quot; required=&quot;true&quot; /&gt;</span>
<span class="s2">   &lt;field name=&quot;_yz_ed&quot; type=&quot;_yz_str&quot; indexed=&quot;true&quot; stored=&quot;true&quot;</span>
<span class="s2">    multiValued=&quot;false&quot; /&gt;</span>
<span class="s2">   &lt;field name=&quot;_yz_pn&quot; type=&quot;_yz_str&quot; indexed=&quot;true&quot; stored=&quot;true&quot;</span>
<span class="s2">    multiValued=&quot;false&quot; /&gt;</span>
<span class="s2">   &lt;field name=&quot;_yz_fpn&quot; type=&quot;_yz_str&quot; indexed=&quot;true&quot; stored=&quot;true&quot;</span>
<span class="s2">    multiValued=&quot;false&quot; /&gt;</span>
<span class="s2">   &lt;field name=&quot;_yz_vtag&quot; type=&quot;_yz_str&quot; indexed=&quot;true&quot; stored=&quot;true&quot;</span>
<span class="s2">    multiValued=&quot;false&quot; /&gt;</span>
<span class="s2">   &lt;field name=&quot;_yz_rk&quot; type=&quot;_yz_str&quot; indexed=&quot;true&quot; stored=&quot;true&quot;</span>
<span class="s2">    multiValued=&quot;false&quot; /&gt;</span>
<span class="s2">   &lt;field name=&quot;_yz_rb&quot; type=&quot;_yz_str&quot; indexed=&quot;true&quot; stored=&quot;true&quot;</span>
<span class="s2">    multiValued=&quot;false&quot; /&gt;</span>
<span class="s2">   &lt;field name=&quot;_yz_rt&quot; type=&quot;_yz_str&quot; indexed=&quot;true&quot; stored=&quot;true&quot;</span>
<span class="s2">    multiValued=&quot;false&quot; /&gt;</span>
<span class="s2">   &lt;field name=&quot;_yz_err&quot; type=&quot;_yz_str&quot; indexed=&quot;true&quot;</span>
<span class="s2">    multiValued=&quot;false&quot; /&gt;</span>
<span class="s2">&lt;/fields&gt;</span>
<span class="s2">&lt;uniqueKey&gt;_yz_id&lt;/uniqueKey&gt;</span>
<span class="s2">&lt;types&gt;</span>
<span class="s2">    &lt;fieldType name=&quot;_yz_str&quot; class=&quot;solr.StrField&quot;</span>
<span class="s2">     sortMissingLast=&quot;true&quot; /&gt;</span>
<span class="s2">&lt;/types&gt;</span>
<span class="s2">&lt;/schema&gt;&quot;&quot;&quot;</span>
<span class="n">schema_name</span> <span class="o">=</span> <span class="s1">&#39;jalapeno&#39;</span>
<span class="n">client</span><span class="o">.</span><span class="n">create_search_schema</span><span class="p">(</span><span class="n">schema_name</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
<p>If you would like to retrieve the current XML Solr schema,
<code class="xref py py-meth docutils literal"><span class="pre">get_search_schema()</span></code> is available:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">schema</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_search_schema</span><span class="p">(</span><span class="s1">&#39;jalapeno&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="solr-indexes">
<h3>Solr indexes<a class="headerlink" href="#solr-indexes" title="Permalink to this headline">¶</a></h3>
<p>Once a schema has been created, then a Solr index must also be created.
This index represents a collection of similar data that you use to perform
queries. When creating an index with
<code class="xref py py-meth docutils literal"><span class="pre">create_search_index()</span></code>, you can optionally
specify a schema. If you do not, the default schema will be used:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">create_search_index</span><span class="p">(</span><span class="s1">&#39;nacho&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Likewise you can specify a schema, e.g. the index <code class="docutils literal"><span class="pre">&quot;nacho&quot;</span></code> is
associated with the schema <code class="docutils literal"><span class="pre">&quot;jalapeno&quot;</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">create_search_index</span><span class="p">(</span><span class="s1">&#39;nacho&#39;</span><span class="p">,</span> <span class="s1">&#39;jalapeno&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Just as easily you can delete an index with
<code class="xref py py-meth docutils literal"><span class="pre">delete_search_index()</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">delete_search_index</span><span class="p">(</span><span class="s1">&#39;jalapeno&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>A single index can be retrieved with
<code class="xref py py-meth docutils literal"><span class="pre">get_search_index()</span></code> or all of them
with <code class="xref py py-meth docutils literal"><span class="pre">list_search_indexes()</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_search_index</span><span class="p">(</span><span class="s1">&#39;jalapeno&#39;</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span>
<span class="n">indexes</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_search_indexes</span><span class="p">()</span>
<span class="n">first_nval</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;n_val&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that index names may only be ASCII values from 32-127
(spaces, standard punctuation, digits and word characters).
This may change in the future to allow full unicode support.</p>
</div>
<p>More discussion about Riak Search 2.0 Indexes can be found at <a class="reference external" href="http://docs.basho.com/riak/2.0.0/dev/advanced/search/#Indexes">Indexes</a>.</p>
</div>
<div class="section" id="linking-a-bucket-type-to-an-index">
<h3>Linking a bucket type to an index<a class="headerlink" href="#linking-a-bucket-type-to-an-index" title="Permalink to this headline">¶</a></h3>
<p>The last step to setting up Riak Search 2.0 is to link a Bucket Type
to a Solr index.  This lets Riak know when to index values.  This can be
done via the command line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">riak</span><span class="o">-</span><span class="n">admin</span> <span class="n">bucket</span><span class="o">-</span><span class="nb">type</span> <span class="n">create</span> <span class="n">spicy</span> <span class="s1">&#39;{&quot;props&quot;:{&quot;search_index&quot;:&quot;jalapeno&quot;}}&#39;</span>
<span class="n">riak</span><span class="o">-</span><span class="n">admin</span> <span class="n">bucket</span><span class="o">-</span><span class="nb">type</span> <span class="n">activate</span> <span class="n">spicy</span>
</pre></div>
</div>
<p>Or simply create an empty Bucket Type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">riak</span><span class="o">-</span><span class="n">admin</span> <span class="n">bucket</span><span class="o">-</span><span class="nb">type</span> <span class="n">create</span> <span class="n">spicy</span> <span class="s1">&#39;{&quot;props&quot;:</span><span class="si">{}</span><span class="s1">}&#39;</span>
<span class="n">riak</span><span class="o">-</span><span class="n">admin</span> <span class="n">bucket</span><span class="o">-</span><span class="nb">type</span> <span class="n">activate</span> <span class="n">spicy</span>
</pre></div>
</div>
<p>Then change the bucket properties on the associated bucket or Bucket Type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="s1">&#39;peppers&#39;</span><span class="p">)</span>
<span class="n">b</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;search_index&#39;</span><span class="p">,</span> <span class="s1">&#39;jalapeno&#39;</span><span class="p">)</span>
<span class="n">btype</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">bucket_type</span><span class="p">(</span><span class="s1">&#39;spicy&#39;</span><span class="p">)</span>
<span class="n">btype</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;search_index&#39;</span><span class="p">,</span> <span class="s1">&#39;jalapeno&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="querying-an-index">
<h3>Querying an index<a class="headerlink" href="#querying-an-index" title="Permalink to this headline">¶</a></h3>
<p>Once the schema, index and bucket properties have all been properly configured,
adding data is as simple as writing to Riak.  Solr is automatically updated.</p>
<p>To query, on the other hand, is as easy as writing Solr queries.  This allows
for the full use of existing Solr tools as well as its rich semantics.</p>
<p>Here is a brief example of loading and querying data::</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="s1">&#39;peppers&#39;</span><span class="p">)</span>
<span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;bell&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name_s&quot;</span><span class="p">:</span> <span class="s2">&quot;bell&quot;</span><span class="p">,</span> <span class="s2">&quot;scoville_low_i&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;scoville_high_i&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
<span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;anaheim&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name_s&quot;</span><span class="p">:</span> <span class="s2">&quot;anaheim&quot;</span><span class="p">,</span> <span class="s2">&quot;scoville_low_i&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                       <span class="s2">&quot;scoville_high_i&quot;</span><span class="p">:</span> <span class="mi">2500</span><span class="p">})</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
<span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;chipotle&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name_s&quot;</span><span class="p">:</span> <span class="s2">&quot;chipotle&quot;</span><span class="p">,</span> <span class="s2">&quot;scoville_low_i&quot;</span><span class="p">:</span> <span class="mi">3500</span><span class="p">,</span>
                        <span class="s2">&quot;scoville_high_i&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">})</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
<span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;serrano&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name_s&quot;</span><span class="p">:</span> <span class="s2">&quot;serrano&quot;</span><span class="p">,</span> <span class="s2">&quot;scoville_low_i&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
                       <span class="s2">&quot;scoville_high_i&quot;</span><span class="p">:</span> <span class="mi">23000</span><span class="p">})</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
<span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;habanero&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name_s&quot;</span><span class="p">:</span> <span class="s2">&quot;habanero&quot;</span><span class="p">,</span> <span class="s2">&quot;scoville_low_i&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
                        <span class="s2">&quot;scoville_high_i&quot;</span><span class="p">:</span> <span class="mi">350000</span><span class="p">})</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;name_s:/c.*/&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;jalapeno&#39;</span><span class="p">)</span>
<span class="c1"># Yields single document &#39;chipotle&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name_s&#39;</span><span class="p">])</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;scoville_high_i:[20000 TO 500000]&quot;</span><span class="p">)</span>
<span class="c1"># Yields two documents</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;name_s&#39;</span><span class="p">])</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;name_s:*&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;jalapeno&#39;</span><span class="p">,</span>
                        <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;scoville_low_i desc&quot;</span><span class="p">)</span>
<span class="c1"># Yields all documents, sorted in descending order. We take the top one</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The hottest pepper is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;docs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name_s&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p>The results returned by <code class="xref py py-meth docutils literal"><span class="pre">search()</span></code> is a dictionary
with lots of search metadata like the number of results, the maxium
<a class="reference external" href="https://lucene.apache.org/core/4_9_0/core/org/apache/lucene/search/package-summary.html#scoring">Lucene Score</a>
as well as the matching documents.</p>
<p>When querying on <a class="reference internal" href="datatypes.html#datatypes"><span class="std std-ref">Data Types</span></a> the datatype is the name of the field
used in Solr since they do not fit into the default schema, e.g.:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">riak</span><span class="o">-</span><span class="n">admin</span> <span class="n">bucket</span><span class="o">-</span><span class="nb">type</span> <span class="n">create</span> <span class="n">visitors</span> <span class="s1">&#39;{&quot;props&quot;:{&quot;datatype&quot;: &quot;counter}}&#39;</span>
<span class="n">riak</span><span class="o">-</span><span class="n">admin</span> <span class="n">bucket</span><span class="o">-</span><span class="nb">type</span> <span class="n">activate</span> <span class="n">visitors</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">create_search_index</span><span class="p">(</span><span class="s1">&#39;website&#39;</span><span class="p">)</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">bucket_type</span><span class="p">(</span><span class="s1">&#39;visitors&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="s1">&#39;hits&#39;</span><span class="p">)</span>
<span class="n">bucket</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;search_index&#39;</span><span class="p">,</span> <span class="s1">&#39;website&#39;</span><span class="p">)</span>

<span class="n">site</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;bbc.co.uk&#39;</span><span class="p">)</span>
<span class="n">site</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
<span class="n">site</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
<span class="n">site</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;cnn.com&#39;</span><span class="p">)</span>
<span class="n">site</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>
<span class="n">site</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
<span class="n">site</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;abc.net.au&#39;</span><span class="p">)</span>
<span class="n">site</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="n">site</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;counter:[10 TO *]&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;website&#39;</span><span class="p">,</span>
                        <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;counter desc&quot;</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Assume you have a bucket-type named &quot;profiles&quot; that has datatype</span>
<span class="c1"># &quot;map&quot;. Let&#39;s create and search an index containing maps.</span>
<span class="n">client</span><span class="o">.</span><span class="n">create_search_index</span><span class="p">(</span><span class="s1">&#39;user-profiles&#39;</span><span class="p">)</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">bucket_type</span><span class="p">(</span><span class="s1">&#39;profiles&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="s1">&#39;USA&#39;</span><span class="p">)</span>
<span class="n">bucket</span><span class="o">.</span><span class="n">set_property</span><span class="p">(</span><span class="s1">&#39;search_index&#39;</span><span class="p">,</span> <span class="s1">&#39;user-profiles&#39;</span><span class="p">)</span>

<span class="n">brett</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">brett</span><span class="o">.</span><span class="n">registers</span><span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="s2">&quot;Brett&quot;</span><span class="p">)</span>
<span class="n">brett</span><span class="o">.</span><span class="n">registers</span><span class="p">[</span><span class="s1">&#39;lname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="s2">&quot;Hazen&quot;</span><span class="p">)</span>
<span class="n">brett</span><span class="o">.</span><span class="n">sets</span><span class="p">[</span><span class="s1">&#39;emails&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;spam@basho.com&#39;</span><span class="p">)</span>
<span class="n">brett</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="s1">&#39;visits&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
<span class="n">brett</span><span class="o">.</span><span class="n">maps</span><span class="p">[</span><span class="s1">&#39;pages&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">counters</span><span class="p">[</span><span class="s1">&#39;homepage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
<span class="n">brett</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

<span class="c1"># Note that the field name in the index/schema is the field name in</span>
<span class="c1"># the map joined with its type by an underscore. Deeply embedded</span>
<span class="c1"># fields are joined with their parent field names by an underscore.</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;lname_register:Hazen AND pages_map_homepage_counter:[1 TO *]&#39;</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="s1">&#39;user-profiles&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Details on querying Riak Search 2.0 can be found at <a class="reference external" href="http://docs.basho.com/riak/2.0.0/dev/using/search/#Querying">Querying</a>.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="security.html" class="btn btn-neutral float-right" title="Security" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="datatypes.html" class="btn btn-neutral" title="Data Types" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2010-2014, Basho Technologies.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.7.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>